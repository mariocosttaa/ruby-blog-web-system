<!-- Header -->
<%= render "panel/_components/header", 
    title: "Edit Post", 
    subtitle: "Update your blog post", 
    breadcrumbs: (
      content_tag(:li, link_to("Dashboard", panel_dashboard_index_path), class: "breadcrumb-item") +
      content_tag(:li, link_to("Posts", panel_posts_index_path), class: "breadcrumb-item") +
      content_tag(:li, "Edit", class: "breadcrumb-item active", aria: { current: "page" })
    ) %>

<!-- Errors -->
<%= render "panel/_components/form_errors", errors: @post.errors.full_messages %>

<div class="container my-4">
  <div class="card shadow-sm rounded-3 border-0">
    <div class="card-body">
      <%= form_with model: @post, url: panel_update_post_path, local: true, multipart: true do |form| %>

        <!-- Post Title -->
        <div class="mb-3">
          <%= form.label :title, "Post Title", class: "form-label" %>
          <%= form.text_field :title, class: "form-control", placeholder: "Enter your post title...", required: true, value: @post.title %>
        </div>

        <!-- Featured Image -->
        <div class="mb-3">
          <%= form.label :image, "Featured Image", class: "form-label" %>
          <% if @post.image.attached? %>
            <div class="mb-2">
              <img src="<%= url_for(@post.image) %>" alt="Current post image" class="img-thumbnail" style="max-width: 200px;">
              <small class="form-text text-muted">Current image</small>
            </div>
          <% end %>
          <%= form.file_field :image, accept: "image/*", class: "form-control" %>
          <small class="form-text text-muted">Supported formats: JPG, PNG, GIF (Max 5MB). Upload a new image to replace the current one.</small>
        </div>

        <!-- Categories (Select2 with tagging) -->
        <div class="mb-3">
          <%= form.label :categories, "Categories", class: "form-label" %>
          <%= form.select :categories, @categories.map { |c| [c.name, c.name] }, { selected: @post.categories.map(&:name) }, { multiple: true, class: "form-select select2", data: { "select2-tagging": true } } %>
        </div>

        <!-- Content -->
        <div class="mb-3">
          <%= form.label :description, "Content", class: "form-label" %>
          <%= form.text_area :description, class: "form-control", rows: 8, placeholder: "Write your post here...", value: @post.description %>
        </div>

        <!-- Tags (Tagify) -->
        <div class="mb-3">
          <%= form.label :tags, "Tags", class: "form-label" %>
          <%= form.text_field :tags, class: "form-control", placeholder: "Type tags...", value: @post.tags.map(&:name).join(','), data: { "tagify": true } %>
        </div>

        <!-- Buttons -->
        <div class="d-flex justify-content-between">
          <%= link_to "Cancel", panel_posts_index_path, class: "btn btn-secondary" %>
          <%= form.submit "Update Post", class: "btn btn-primary" %>
        </div>

      <% end %>
    </div>
  </div>
</div>

<!-- CDNs -->
<%= javascript_include_tag "https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.0/jquery.min.js" %>
<%= stylesheet_link_tag "https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" %>
<%= javascript_include_tag "https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js" %>

<%= stylesheet_link_tag "https://cdn.jsdelivr.net/npm/@yaireo/tagify/dist/tagify.css" %>
<%= javascript_include_tag "https://cdn.jsdelivr.net/npm/@yaireo/tagify/dist/tagify.min.js" %>

<script>
  document.addEventListener("DOMContentLoaded", function() {
    // Select2 init with tagging
    $('.select2').select2({
      placeholder: "Select or create categories",
      width: '100%',
      tags: true,
      createTag: function(params) {
        return {
          id: params.term,
          text: params.term,
          newOption: true
        }
      }
    });

    // Tagify init
    document.querySelectorAll('input[data-tagify]').forEach(input => {
      new Tagify(input, {
        whitelist: <%= raw @tags.map { |t| "\"#{t.name}\"" }.join(",").prepend("[").concat("]") %>,
        dropdown: { enabled: 1, maxItems: 10, classname: 'tags-look', highlightFirst: true },
        originalInputValueFormat: valuesArr => valuesArr.map(item => item.value).join(',')
      });
    });
  });
</script>