<!-- Header -->
<%= render "panel/_components/header", 
    title: "Create New Post", 
    subtitle: "Write and publish a new blog post", 
    breadcrumbs: (
      content_tag(:li, link_to("Dashboard", panel_dashboard_index_path, class: "text-purple hover:text-purple/80"), class: "flex items-center") +
      content_tag(:li, link_to("Posts", panel_posts_index_path, class: "text-purple hover:text-purple/80"), class: "flex items-center") +
      content_tag(:li, "New Post", class: "flex items-center text-secondary", aria: { current: "page" })
    ) %>

<!-- Errors -->
<%= render "panel/_components/form_errors", errors: @post.errors.full_messages %>

<div class="max-w-4xl mx-auto">
  <div class="bg-card rounded-xl shadow-sm border border-theme overflow-hidden animate-on-scroll">
    <div class="p-8">
      <%= form_with model: @post, url: panel_create_post_path, local: true, multipart: true, class: "space-y-6" do |form| %>

        <!-- Post Title -->
        <div>
          <%= form.label :title, "Post Title", class: "block text-sm font-medium text-secondary mb-2" %>
          <%= form.text_field :title, 
              class: "w-full px-4 py-3 border border-theme rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-colors duration-200", 
              style: "background-color: var(--card-bg); color: var(--text-color);",
              placeholder: "Enter your post title...", 
              required: true, 
              value: @post.title %>
        </div>

        <!-- Featured Image -->
        <div>
          <%= form.label :image, "Featured Image", class: "block text-sm font-medium text-secondary mb-2" %>
          <%= form.file_field :image, 
              accept: "image/*", 
              class: "w-full px-4 py-3 border border-theme rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-colors duration-200",
              style: "background-color: var(--card-bg); color: var(--text-color);" %>
          <p class="mt-2 text-sm text-secondary">Supported formats: JPG, PNG, GIF (Max 5MB)</p>
        </div>

        <!-- Categories (Select2 with tagging) -->
        <div>
          <%= form.label :categories, "Categories", class: "block text-sm font-medium text-secondary mb-2" %>
          <%= form.select :categories, 
              @categories.map { |c| [c.name, c.name] }, 
              { selected: @submitted_categories || [] }, 
              { multiple: true, 
                class: "w-full px-4 py-3 border border-theme rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-colors duration-200 select2",
                style: "background-color: var(--card-bg); color: var(--text-color);", 
                data: { "select2-tagging": true } } %>
        </div>

        <!-- Content (Quill.js Editor) -->
        <div>
          <%= form.label :description, "Content", class: "block text-sm font-medium text-secondary mb-2" %>
          <p class="text-sm text-purple mb-3">Minimum 100 characters.</p>
          <div id="editor" class="min-h-[300px] border border-theme rounded-lg"></div>
          <%= form.hidden_field :description, id: "post_description", value: @post.description %>
        </div>

        <!-- Tags (Tagify) -->
        <div>
          <%= form.label :tags, "Tags", class: "block text-sm font-medium text-secondary mb-2" %>
          <%= form.text_field :tags, 
              class: "w-full px-4 py-3 border border-theme rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-colors duration-200", 
              style: "background-color: var(--card-bg); color: var(--text-color);",
              placeholder: "Type tags...", 
              value: @submitted_tags&.join(','), 
              data: { "tagify": true } %>
        </div>

        <!-- Buttons -->
        <div class="flex justify-between pt-6 border-t border-theme">
          <%= link_to "Cancel", panel_posts_index_path, 
              class: "px-6 py-3 border border-theme text-secondary rounded-lg transition-colors duration-200",
              style: "color: var(--text-color); background-color: var(--card-bg);" %>
          <%= form.submit "Publish Post", 
              class: "px-8 py-3 bg-purple-600 hover:bg-purple-700 text-white rounded-lg font-medium transition-colors duration-200" %>
        </div>

      <% end %>
    </div>
  </div>
</div>

<!-- CDNs -->
<%= javascript_include_tag "https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.0/jquery.min.js" %>
<%= stylesheet_link_tag "https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" %>
<%= javascript_include_tag "https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js" %>
<%= stylesheet_link_tag "https://cdn.jsdelivr.net/npm/@yaireo/tagify/dist/tagify.css" %>
<%= javascript_include_tag "https://cdn.jsdelivr.net/npm/@yaireo/tagify/dist/tagify.min.js" %>
<%= stylesheet_link_tag "https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.snow.css" %>
<%= javascript_include_tag "https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.min.js" %>

<script>
  document.addEventListener("DOMContentLoaded", function() {
    // Initialize Quill editor
    const quill = new Quill('#editor', {
      theme: 'snow',
      modules: {
        toolbar: [
          [{ 'header': [1, 2, 3, false] }],
          ['bold', 'italic', 'underline', 'strike'],
          [{ 'list': 'ordered'}, { 'list': 'bullet' }],
          ['link', 'image', 'code-block'],
          ['blockquote', 'code'],
          [{ 'align': [] }],
          ['clean']
        ]
      },
      placeholder: 'Write your post here...',
    });

    // Populate Quill editor with existing description (if any)
    <% if @post.description.present? %>
      quill.root.innerHTML = <%= raw @post.description.to_json %>;
    <% end %>

    // Sync Quill content with hidden form field
    quill.on('text-change', function() {
      document.getElementById('post_description').value = quill.root.innerHTML;
    });

    // Select2 init with tagging
    $('.select2').select2({
      placeholder: "Select or create categories",
      width: '100%',
      tags: true,
      createTag: function(params) {
        return {
          id: params.term,
          text: params.term,
          newOption: true
        }
      }
    });

    // Tagify init
    document.querySelectorAll('input[data-tagify]').forEach(input => {
      new Tagify(input, {
        whitelist: <%= raw @tags.map { |t| "\"#{t.name}\"" }.join(",").prepend("[").concat("]") %>,
        dropdown: { enabled: 1, maxItems: 10, classname: 'tags-look', highlightFirst: true },
        originalInputValueFormat: valuesArr => valuesArr.map(item => item.value).join(',')
      });
    });

    // Client-side validation for minimum 100 characters in description
    document.querySelector('form').addEventListener('submit', function(event) {
      const description = quill.getText().trim();
      if (description.length < 100) {
        event.preventDefault();
        alert('Description must be at least 100 characters long.');
      }
    });
  });
</script>