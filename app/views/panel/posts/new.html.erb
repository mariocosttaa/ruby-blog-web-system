<!-- Header -->
<%= render "panel/_components/header", 
    title: "Create New Post", 
    subtitle: "Write and publish a new blog post", 
    breadcrumbs: (
      content_tag(:li, link_to("Dashboard", panel_dashboard_index_path), class: "breadcrumb-item") +
      content_tag(:li, "Posts", class: "breadcrumb-item active", aria: { current: "page" })
    ) %>

<!-- Errors -->
<%= render "panel/_components/form_errors", errors: @post.errors.full_messages %>

<div class="container my-4">
  <div class="card shadow-sm rounded-3 border-0">
    <div class="card-body">
      <%= form_with model: @post, url: panel_create_post_path, local: true, multipart: true do |form| %>

        <!-- Post Title -->
        <div class="mb-3">
          <%= form.label :title, "Post Title *", class: "form-label" %>
          <%= form.text_field :title, class: "form-control", placeholder: "Enter your post title...", required: true, value: @post.title %>
        </div>

        <!-- Featured Image -->
        <div class="mb-3">
          <%= form.label :image, "Featured Image", class: "form-label" %>
          <%= form.file_field :image, accept: "image/*", class: "form-control" %>
          <small class="form-text text-muted">Supported formats: JPG, PNG, GIF (Max 5MB)</small>
        </div>

        <!-- Categories (Select2 with tagging) -->
        <div class="mb-3">
          <%= form.label :categories, "Categories *", class: "form-label" %>
          <%= form.select :categories, @categories.map { |c| [c.name, c.name] }, { selected: @submitted_categories || [] }, { multiple: true, class: "form-select select2", data: { "select2-tagging": true } } %>
        </div>

        <!-- Content (Quill.js Editor) -->
        <div class="mb-3">
          <%= form.label :description, "Description *", class: "form-label" %>
          <small class="text-info d-block" style="margin-top: -10px; padding-bottom: 10px;">Minimum 100 characters.</small>
          <div id="editor" style="min-height: 200px;"></div>
          <%= form.hidden_field :description, id: "post_description", value: @post.description %>
        </div>

        <!-- Tags (Tagify) -->
        <div class="mb-3">
          <%= form.label :tags, "Tags *", class: "form-label" %>
          <%= form.text_field :tags, class: "form-control", placeholder: "Type tags...", value: @submitted_tags&.join(','), data: { "tagify": true } %>
        </div>

        <!-- Buttons -->
        <div class="d-flex justify-content-between">
          <%= link_to "Cancel", panel_posts_index_path, class: "btn btn-secondary" %>
          <%= form.submit "Publish Post", class: "btn btn-primary" %>
        </div>

      <% end %>
    </div>
  </div>
</div>

<!-- CDNs -->
<%= javascript_include_tag "https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.0/jquery.min.js" %>
<%= stylesheet_link_tag "https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" %>
<%= javascript_include_tag "https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js" %>
<%= stylesheet_link_tag "https://cdn.jsdelivr.net/npm/@yaireo/tagify/dist/tagify.css" %>
<%= javascript_include_tag "https://cdn.jsdelivr.net/npm/@yaireo/tagify/dist/tagify.min.js" %>
<%= stylesheet_link_tag "https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.snow.css" %>
<%= javascript_include_tag "https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.min.js" %>

<script>
  document.addEventListener("DOMContentLoaded", function() {
    // Initialize Quill editor
    const quill = new Quill('#editor', {
      theme: 'snow',
      modules: {
        toolbar: [
          [{ 'header': [1, 2, 3, false] }],
          ['bold', 'italic', 'underline', 'strike'],
          [{ 'list': 'ordered'}, { 'list': 'bullet' }],
          ['link', 'image', 'code-block'],
          ['blockquote', 'code'],
          [{ 'align': [] }],
          ['clean']
        ]
      },
      placeholder: 'Write your post here...',
    });

    // Populate Quill editor with existing description (if any)
    <% if @post.description.present? %>
      quill.root.innerHTML = <%= raw @post.description.to_json %>;
    <% end %>

    // Sync Quill content with hidden form field
    quill.on('text-change', function() {
      document.getElementById('post_description').value = quill.root.innerHTML;
    });

    // Select2 init with tagging
    $('.select2').select2({
      placeholder: "Select or create categories",
      width: '100%',
      tags: true,
      createTag: function(params) {
        return {
          id: params.term,
          text: params.term,
          newOption: true
        }
      }
    });

    // Tagify init
    document.querySelectorAll('input[data-tagify]').forEach(input => {
      new Tagify(input, {
        whitelist: <%= raw @tags.map { |t| "\"#{t.name}\"" }.join(",").prepend("[").concat("]") %>,
        dropdown: { enabled: 1, maxItems: 10, classname: 'tags-look', highlightFirst: true },
        originalInputValueFormat: valuesArr => valuesArr.map(item => item.value).join(',')
      });
    });

    // Client-side validation for minimum 100 characters in description
    document.querySelector('form').addEventListener('submit', function(event) {
      const description = quill.getText().trim();
      if (description.length < 100) {
        event.preventDefault();
        alert('Description must be at least 100 characters long.');
      }
    });
  });
</script>